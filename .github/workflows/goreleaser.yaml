name: goreleaser

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      -
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      -
        name: Extract release notes from CHANGELOG.md
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${GITHUB_REF_NAME#v}"

          # Extract the section for this version (until the next version header).
          awk -v ver="$VERSION" '
            $0 ~ "^## \\[" ver "\\]" {p=1}
            p==1 && $0 ~ "^## \\[" && $0 !~ "^## \\[" ver "\\]" {exit}
            p==1 {print}
          ' CHANGELOG.md > release_notes.md

          if [[ ! -s release_notes.md ]]; then
            echo "release_notes.md is empty (version=$VERSION)" >&2
            exit 1
          fi

          echo "Extracted release notes for version: $VERSION"
          # Keep logs small: show only the first 60 lines.
          sed -n '1,60p' release_notes.md
          if [[ "$(wc -l < release_notes.md)" -gt 60 ]]; then
            echo "(truncated; see release_notes.md artifact inside the job workspace)"
          fi
      -
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
      -
        name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          args: release --clean --release-notes=release_notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
